{
  "displayName": "Chronicle-Sniffer Operational Dashboard",
  "gridLayout": {
    "columns": 4,
    "widgets": [
      {
        "text": {
          "content": "# Sniffer & Edge Overview\n---",
          "format": "MARKDOWN"
        }
      },
      {
        "title": "Active Sniffers (Last Hour)",
        "scorecard": {
          "timeSeriesQuery": {
            "timeSeriesFilter": {
              "filter": "metric.type=\"logging.googleapis.com/user/sniffer_heartbeat_count\" resource.type=\"global\"",
              "aggregation": {
                "alignmentPeriod": "3600s",
                "perSeriesAligner": "ALIGN_SUM",
                "crossSeriesReducer": "REDUCE_COUNT_TRUE",
                "groupByFields": ["metric.label.sniffer_id"]
              },
              "secondaryAggregation": {
                 "crossSeriesReducer": "REDUCE_SUM",
                 "groupByFields": []
              }
            }
          },
          "sparkChartView": { "sparkChartType": "SPARK_LINE" },
          "thresholds": [
            {
              "label": "Warning",
              "value": 1.0,
              "color": "YELLOW",
              "direction": "BELOW"
            },
            {
              "label": "Critical",
              "value": 0.5,
              "color": "RED",
              "direction": "BELOW"
            }
          ]
        }
      },
      {
        "title": "Total PCAP Volume Uploaded (Last Hour)",
        "scorecard": {
          "timeSeriesQuery": {
            "timeSeriesQueryLanguage": "fetch global\n| metric 'logging.googleapis.com/user/pcap_file_size_bytes'\n| align delta(1h)\n| group_by [], [value_sum_increase: sum(value.distribution_value.sum)]"
          },
          "sparkChartView": { "sparkChartType": "SPARK_LINE" }
        }
      },
      {
        "title": "Sniffer Heartbeats (by Sniffer ID & Interface)",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "metric.type=\"logging.googleapis.com/user/sniffer_heartbeat_count\" resource.type=\"global\"",
                  "aggregation": {
                    "alignmentPeriod": "60s",
                    "perSeriesAligner": "ALIGN_RATE",
                    "crossSeriesReducer": "REDUCE_NONE",
                    "groupByFields": ["metric.label.sniffer_id", "metric.label.interface"]
                  }
                }
              },
              "plotType": "LINE", "targetAxis": "Y1", "minAlignmentPeriod": "60s",
              "legendTemplate": "{{metric.label.sniffer_id}} ({{metric.label.interface}})"
            }
          ],
          "yAxis": { "label": "Heartbeats/sec", "scale": "LINEAR" }
        }
      },
      {
        "title": "PCAP Files Uploaded (by Sniffer ID)",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "metric.type=\"logging.googleapis.com/user/pcap_files_uploaded_count\" resource.type=\"global\"",
                  "aggregation": {
                    "alignmentPeriod": "60s", "perSeriesAligner": "ALIGN_RATE",
                    "crossSeriesReducer": "REDUCE_NONE",
                    "groupByFields": ["metric.label.sniffer_id"]
                  }
                }
              },
              "plotType": "LINE", "targetAxis": "Y1", "minAlignmentPeriod": "60s",
              "legendTemplate": "{{metric.label.sniffer_id}}"
            }
          ],
          "yAxis": { "label": "Uploads/sec", "scale": "LINEAR" }
        }
      },
      {
        "title": "Avg PCAP File Size Uploaded (by Sniffer ID)",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                 "timeSeriesQueryLanguage": "fetch global\n| metric 'logging.googleapis.com/user/pcap_file_size_bytes'\n| group_by [metric.label.sniffer_id], [value_count: count(value.distribution_value.count), value_sum: sum(value.distribution_value.sum)]\n| every 60s\n| condition val().value_count > 0\n| value [value: val().value_sum / val().value_count]"
              },
              "plotType": "LINE", "targetAxis": "Y1",
              "legendTemplate": "{{metric.label.sniffer_id}}"
            }
          ],
          "yAxis": { "label": "Avg Size (Bytes)", "scale": "LINEAR" }
        }
      },
      {
        "title": "PCAP Upload Errors (by Sniffer ID)",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "metric.type=\"logging.googleapis.com/user/pcap_upload_errors_count\" resource.type=\"global\"",
                  "aggregation": {
                    "alignmentPeriod": "60s", "perSeriesAligner": "ALIGN_DELTA",
                    "crossSeriesReducer": "REDUCE_NONE",
                    "groupByFields": ["metric.label.sniffer_id"]
                  }
                }
              },
              "plotType": "LINE", "targetAxis": "Y1", "minAlignmentPeriod": "60s",
              "legendTemplate": "{{metric.label.sniffer_id}}"
            }
          ],
          "yAxis": { "label": "Error Count / min", "scale": "LINEAR" }
        }
      },
      {
        "title": "Pub/Sub Publish Errors (by Sniffer ID)",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "metric.type=\"logging.googleapis.com/user/pubsub_publish_errors_count\" resource.type=\"global\"",
                  "aggregation": {
                    "alignmentPeriod": "60s", "perSeriesAligner": "ALIGN_DELTA",
                    "crossSeriesReducer": "REDUCE_NONE",
                    "groupByFields": ["metric.label.sniffer_id"]
                  }
                }
              },
              "plotType": "LINE", "targetAxis": "Y1", "minAlignmentPeriod": "60s",
              "legendTemplate": "{{metric.label.sniffer_id}}"
            }
          ],
          "yAxis": { "label": "Error Count / min", "scale": "LINEAR" }
        }
      },
      {
        "text": {
          "content": "# Cloud Processing Pipeline Overview\n---",
          "format": "MARKDOWN"
        }
      },
      {
        "title": "Cloud Run - Processed Requests (Success) - ${cloud_run_processor_service_name}",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "metric.type=\"run.googleapis.com/request_count\" resource.labels.service_name=\"${cloud_run_processor_service_name}\" metric.labels.response_code_class=\"2xx\"",
                  "aggregation": { "alignmentPeriod": "60s", "perSeriesAligner": "ALIGN_RATE", "crossSeriesReducer": "REDUCE_SUM"}
                }
              },
              "plotType": "STACKED_BAR", "targetAxis": "Y1", "minAlignmentPeriod": "60s"
            }
          ],
          "yAxis": { "label": "Requests/sec", "scale": "LINEAR" }
        }
      },
      {
        "title": "Pub/Sub - Unacked Msgs (Sub: ${pubsub_processor_subscription_id})",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "metric.type=\"pubsub.googleapis.com/subscription/num_unacked_messages_by_region\" resource.labels.subscription_id=\"${pubsub_processor_subscription_id}\"",
                  "aggregation": { "alignmentPeriod": "60s", "perSeriesAligner": "ALIGN_MAX", "crossSeriesReducer": "REDUCE_MAX"}
                }
              },
              "plotType": "LINE", "targetAxis": "Y1", "minAlignmentPeriod": "60s"
            }
          ],
          "yAxis": { "label": "Count", "scale": "LINEAR" }
        }
      },
       {
        "title": "Pub/Sub - DLQ Messages (Sub: ${pubsub_processor_subscription_id}-dlq)",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "metric.type=\"pubsub.googleapis.com/subscription/num_undelivered_messages\" resource.labels.subscription_id=\"${pubsub_processor_subscription_id}-dlq\"",
                   "aggregation": { "alignmentPeriod": "60s", "perSeriesAligner": "ALIGN_MAX", "crossSeriesReducer": "REDUCE_MAX"}
                }
              },
              "plotType": "LINE", "targetAxis": "Y1", "minAlignmentPeriod": "60s"
            }
          ],
          "yAxis": { "label": "DLQ Msg Count", "scale": "LINEAR" }
        }
      },
      {
        "text": {
          "content": "# Cloud Processor Performance Details\n---",
          "format": "MARKDOWN"
        }
      },
      {
        "title": "Processor - PCAP Download Success Rate",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "metric.type=\"logging.googleapis.com/user/processor_pcap_download_success_count\" resource.type=\"cloud_run_revision\" resource.labels.service_name=\"${cloud_run_processor_service_name}\"",
                  "aggregation": { "alignmentPeriod": "60s", "perSeriesAligner": "ALIGN_RATE", "crossSeriesReducer": "REDUCE_SUM"}
                }
              },
              "plotType": "LINE", "targetAxis": "Y1", "minAlignmentPeriod": "60s"
            }
          ],
          "yAxis": { "label": "Downloads/sec", "scale": "LINEAR" }
        }
      },
      {
        "title": "Processor - PCAP Download Not Found",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "metric.type=\"logging.googleapis.com/user/processor_pcap_download_notfound_count\" resource.type=\"cloud_run_revision\" resource.labels.service_name=\"${cloud_run_processor_service_name}\"",
                  "aggregation": { "alignmentPeriod": "60s", "perSeriesAligner": "ALIGN_DELTA", "crossSeriesReducer": "REDUCE_SUM"}
                }
              },
              "plotType": "LINE", "targetAxis": "Y1", "minAlignmentPeriod": "60s"
            }
          ],
          "yAxis": { "label": "Not Found Count / min", "scale": "LINEAR" }
        }
      },
      {
        "title": "Processor - TShark Conversion Success Rate",
        "xyChart": {
           "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "metric.type=\"logging.googleapis.com/user/processor_tshark_conversion_success_count\" resource.type=\"cloud_run_revision\" resource.labels.service_name=\"${cloud_run_processor_service_name}\"",
                  "aggregation": { "alignmentPeriod": "60s", "perSeriesAligner": "ALIGN_RATE", "crossSeriesReducer": "REDUCE_SUM"}
                }
              },
              "plotType": "LINE", "targetAxis": "Y1", "minAlignmentPeriod": "60s"
            }
          ],
          "yAxis": { "label": "Conversions/sec", "scale": "LINEAR" }
        }
      },
      {
        "title": "Processor - TShark Conversion Errors",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "metric.type=\"logging.googleapis.com/user/processor_tshark_conversion_error_count\" resource.type=\"cloud_run_revision\" resource.labels.service_name=\"${cloud_run_processor_service_name}\"",
                  "aggregation": { "alignmentPeriod": "60s", "perSeriesAligner": "ALIGN_DELTA", "crossSeriesReducer": "REDUCE_SUM"}
                }
              },
              "plotType": "LINE", "targetAxis": "Y1", "minAlignmentPeriod": "60s"
            }
          ],
          "yAxis": { "label": "Error Count / min", "scale": "LINEAR" }
        }
      },
      {
        "title": "Processor - UDM Packets Processed Rate",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesQueryLanguage": "fetch cloud_run_revision\n| metric 'logging.googleapis.com/user/processor_udm_packets_processed_count'\n| filter (resource.service_name == '${cloud_run_processor_service_name}')\n| group_by [metric.label.filename], 60s, [value_sum_rate: rate(sum(value.distribution_value.sum))]\n| every 60s"
              },
              "plotType": "LINE", "targetAxis": "Y1",
              "legendTemplate": "{{metric.label.filename}}"
            }
          ],
          "yAxis": { "label": "UDM Packets/sec", "scale": "LINEAR" }
        }
      },
      {
        "title": "Processor - UDM Packet Processing Errors Rate",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesQueryLanguage": "fetch cloud_run_revision\n| metric 'logging.googleapis.com/user/processor_udm_packet_errors_count'\n| filter (resource.service_name == '${cloud_run_processor_service_name}')\n| group_by [metric.label.filename], 60s, [value_sum_rate: rate(sum(value.distribution_value.sum))]\n| every 60s"
              },
              "plotType": "LINE", "targetAxis": "Y1",
              "legendTemplate": "{{metric.label.filename}}"
            }
          ],
          "yAxis": { "label": "Errored Packets/sec", "scale": "LINEAR" }
        }
      },
      {
        "title": "Processor - UDM Upload Success Rate",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "metric.type=\"logging.googleapis.com/user/processor_udm_upload_success_count\" resource.type=\"cloud_run_revision\" resource.labels.service_name=\"${cloud_run_processor_service_name}\"",
                  "aggregation": { "alignmentPeriod": "60s", "perSeriesAligner": "ALIGN_RATE", "crossSeriesReducer": "REDUCE_SUM"}
                }
              },
              "plotType": "LINE", "targetAxis": "Y1", "minAlignmentPeriod": "60s"
            }
          ],
          "yAxis": { "label": "Uploads/sec", "scale": "LINEAR" }
        }
      },
      {
        "text": {
          "content": "# End-to-End Processing Latency\n---",
          "format": "MARKDOWN"
        }
      },
      {
        "title": "Processor - Avg PCAP Processing Latency",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                 "timeSeriesQueryLanguage": "fetch cloud_run_revision\n| metric 'logging.googleapis.com/user/processor_pcap_processing_latency_seconds'\n| filter (resource.service_name == '${cloud_run_processor_service_name}')\n| group_by [], [value_mean: mean(value.distribution_value.mean)]\n| every 60s"
              },
              "plotType": "LINE", "targetAxis": "Y1"
            }
          ],
          "yAxis": { "label": "Avg Latency (s)", "scale": "LINEAR" }
        }
      },
      {
        "title": "Processor - 95th Percentile PCAP Processing Latency",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "timeSeriesFilter": {
                  "filter": "metric.type=\"logging.googleapis.com/user/processor_pcap_processing_latency_seconds\" resource.type=\"cloud_run_revision\" resource.labels.service_name=\"${cloud_run_processor_service_name}\"",
                  "aggregation": {
                    "alignmentPeriod": "60s",
                    "perSeriesAligner": "ALIGN_PERCENTILE_95",
                    "crossSeriesReducer": "REDUCE_NONE"
                  }
                }
              },
              "plotType": "LINE", "targetAxis": "Y1", "minAlignmentPeriod": "60s"
            }
          ],
          "yAxis": { "label": "95p Latency (s)", "scale": "LINEAR" }
        }
      }
    ]
  }
}