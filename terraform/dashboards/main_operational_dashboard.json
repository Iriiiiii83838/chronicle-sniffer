{
  "displayName": "Chronicle-Sniffer Operational Dashboard",
  "gridLayout": {
    "columns": 4,
    "widgets": [
      {
        "text": {
          "content": "# Panoramica Sniffer On-Premises/Edge\n---",
          "format": "MARKDOWN"
        }
      },
      {
        "title": "Sniffer Heartbeats (by Sniffer ID & Interface)",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(rate(logging_googleapis_com_user_sniffer_heartbeat_count_total{monitored_resource=\"global\"}[$${__interval}])) by (sniffer_id, interface)"
              },
              "plotType": "LINE",
              "targetAxis": "Y1",
              "legendTemplate": "{{sniffer_id}} ({{interface}})"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Heartbeats/min",
            "scale": "LINEAR"
          }
        }
      },
      {
        "title": "Sniffer TShark Status (1=Running, by ID)",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "max_over_time(sum(rate(logging_googleapis_com_user_sniffer_tshark_status_running_count_total{monitored_resource=\"global\"}[$${__interval}])) by (sniffer_id) > 0 [$${__range_vector_interval}:])"
              },
              "plotType": "LINE",
              "targetAxis": "Y1",
              "legendTemplate": "{{sniffer_id}}"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Status (1=Running)",
            "scale": "LINEAR"
          }
        }
      },
      {
        "title": "PCAP Files Uploaded (by Sniffer ID)",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(rate(logging_googleapis_com_user_pcap_files_uploaded_count_total{monitored_resource=\"global\"}[$${__interval}])) by (sniffer_id)"
              },
              "plotType": "LINE",
              "targetAxis": "Y1",
              "legendTemplate": "{{sniffer_id}}"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Uploads/min",
            "scale": "LINEAR"
          }
        }
      },
      {
        "title": "Avg PCAP File Size Uploaded (by Sniffer ID)",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(rate(logging_googleapis_com_user_pcap_file_size_bytes_sum{monitored_resource=\"global\"}[$${__interval}])) by (sniffer_id) / sum(rate(logging_googleapis_com_user_pcap_file_size_bytes_count{monitored_resource=\"global\"}[$${__interval}])) by (sniffer_id)"
              },
              "plotType": "LINE",
              "targetAxis": "Y1",
              "legendTemplate": "{{sniffer_id}}"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Avg Size (Bytes)",
            "scale": "LINEAR"
          }
        }
      },
      {
        "title": "PCAP Upload Errors (by Sniffer ID)",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(increase(logging_googleapis_com_user_pcap_upload_errors_count_total{monitored_resource=\"global\"}[$${__interval}])) by (sniffer_id)"
              },
              "plotType": "LINE",
              "targetAxis": "Y1",
              "legendTemplate": "{{sniffer_id}}"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Error Count (sum over interval)",
            "scale": "LINEAR"
          }
        }
      },
      {
        "title": "Pub/Sub Publish Errors (by Sniffer ID)",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(increase(logging_googleapis_com_user_pubsub_publish_errors_count_total{monitored_resource=\"global\"}[$${__interval}])) by (sniffer_id)"
              },
              "plotType": "LINE",
              "targetAxis": "Y1",
              "legendTemplate": "{{sniffer_id}}"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Error Count (sum over interval)",
            "scale": "LINEAR"
          }
        }
      },
      {
        "text": {
          "content": "# Panoramica Pipeline di Elaborazione Cloud\n---",
          "format": "MARKDOWN"
        }
      },
      {
        "title": "Cloud Run - Processed Requests (Success) - ${cloud_run_processor_service_name}",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(rate(run_googleapis_com_request_count{service_name=\"${cloud_run_processor_service_name}\", response_code_class=\"2xx\"}[$${__interval}]))"
              },
              "plotType": "STACKED_BAR",
              "targetAxis": "Y1"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Requests/sec",
            "scale": "LINEAR"
          }
        }
      },
      {
        "title": "Pub/Sub - Unacked Msgs (Sub: ${pubsub_processor_subscription_id})",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "max_over_time(pubsub_googleapis_com_subscription_num_unacked_messages_by_region{subscription_id=\"${pubsub_processor_subscription_id}\"}[$${__interval}])"
              },
              "plotType": "LINE",
              "targetAxis": "Y1"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Count",
            "scale": "LINEAR"
          }
        }
      },
       {
        "title": "Pub/Sub - DLQ Messages (Sub: ${pubsub_processor_subscription_id}-dlq)",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "max_over_time(pubsub_googleapis_com_subscription_num_undelivered_messages{subscription_id=\"${pubsub_processor_subscription_id}-dlq\"}[$${__interval}])"
              },
              "plotType": "LINE",
              "targetAxis": "Y1"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "DLQ Msg Count",
            "scale": "LINEAR"
          }
        }
      },
      {
        "text": {
          "content": "# Dettaglio Prestazioni Processor Cloud Run\n---",
          "format": "MARKDOWN"
        }
      },
      {
        "title": "Processor - PCAP Download Success Rate",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(rate(logging_googleapis_com_user_processor_pcap_download_success_count_total{monitored_resource=\"cloud_run_revision\", service_name=\"${cloud_run_processor_service_name}\"}[$${__interval}]))"
              },
              "plotType": "LINE",
              "targetAxis": "Y1"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Downloads/sec",
            "scale": "LINEAR"
          }
        }
      },
      {
        "title": "Processor - PCAP Download Not Found",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(increase(logging_googleapis_com_user_processor_pcap_download_notfound_count_total{monitored_resource=\"cloud_run_revision\", service_name=\"${cloud_run_processor_service_name}\"}[$${__interval}]))"
              },
              "plotType": "LINE",
              "targetAxis": "Y1"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Not Found Count",
            "scale": "LINEAR"
          }
        }
      },
      {
        "title": "Processor - TShark Conversion Success Rate",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(rate(logging_googleapis_com_user_processor_tshark_conversion_success_count_total{monitored_resource=\"cloud_run_revision\", service_name=\"${cloud_run_processor_service_name}\"}[$${__interval}]))"
              },
              "plotType": "LINE",
              "targetAxis": "Y1"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Conversions/sec",
            "scale": "LINEAR"
          }
        }
      },
      {
        "title": "Processor - TShark Conversion Errors",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(increase(logging_googleapis_com_user_processor_tshark_conversion_error_count_total{monitored_resource=\"cloud_run_revision\", service_name=\"${cloud_run_processor_service_name}\"}[$${__interval}]))"
              },
              "plotType": "LINE",
              "targetAxis": "Y1"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Error Count",
            "scale": "LINEAR"
          }
        }
      },
      {
        "title": "Processor - UDM Packets Processed Rate",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(rate(logging_googleapis_com_user_processor_udm_packets_processed_count_sum{monitored_resource=\"cloud_run_revision\", service_name=\"${cloud_run_processor_service_name}\"}[$${__interval}]))"
              },
              "plotType": "LINE",
              "targetAxis": "Y1"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "UDM Packets/sec",
            "scale": "LINEAR"
          }
        }
      },
      {
        "title": "Processor - UDM Packet Processing Errors Rate",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(rate(logging_googleapis_com_user_processor_udm_packet_errors_count_sum{monitored_resource=\"cloud_run_revision\", service_name=\"${cloud_run_processor_service_name}\"}[$${__interval}]))"
              },
              "plotType": "LINE",
              "targetAxis": "Y1"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Errored Packets/sec",
            "scale": "LINEAR"
          }
        }
      },
      {
        "title": "Processor - UDM Upload Success Rate",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(rate(logging_googleapis_com_user_processor_udm_upload_success_count_total{monitored_resource=\"cloud_run_revision\", service_name=\"${cloud_run_processor_service_name}\"}[$${__interval}]))"
              },
              "plotType": "LINE",
              "targetAxis": "Y1"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Uploads/sec",
            "scale": "LINEAR"
          }
        }
      },
      {
        "text": {
          "content": "# Latenza di Elaborazione End-to-End\n---",
          "format": "MARKDOWN"
        }
      },
      {
        "title": "Processor - Avg PCAP Processing Latency",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "sum(rate(logging_googleapis_com_user_processor_pcap_processing_latency_seconds_sum{monitored_resource=\"cloud_run_revision\", service_name=\"${cloud_run_processor_service_name}\"}[$${__interval}])) / sum(rate(logging_googleapis_com_user_processor_pcap_processing_latency_seconds_count{monitored_resource=\"cloud_run_revision\", service_name=\"${cloud_run_processor_service_name}\"}[$${__interval}]))"
              },
              "plotType": "LINE",
              "targetAxis": "Y1"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "Avg Latency (s)",
            "scale": "LINEAR"
          }
        }
      },
      {
        "title": "Processor - 95th Percentile PCAP Processing Latency",
        "xyChart": {
          "dataSets": [
            {
              "timeSeriesQuery": {
                "prometheusQuery": "histogram_quantile(0.95, sum(rate(logging_googleapis_com_user_processor_pcap_processing_latency_seconds_bucket{monitored_resource=\"cloud_run_revision\", service_name=\"${cloud_run_processor_service_name}\"}[$${__interval}])) by (le))"
              },
              "plotType": "LINE",
              "targetAxis": "Y1"
            }
          ],
          "timeshiftDuration": "0s",
          "yAxis": {
            "label": "95p Latency (s)",
            "scale": "LINEAR"
          }
        }
      }
    ]
  }
}